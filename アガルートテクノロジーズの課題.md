<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [今アガルートはどのような課題を抱えているのか](#%E4%BB%8A%E3%82%A2%E3%82%AC%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AF%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E8%AA%B2%E9%A1%8C%E3%82%92%E6%8A%B1%E3%81%88%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%8B)
  - [技術的課題](#%E6%8A%80%E8%A1%93%E7%9A%84%E8%AA%B2%E9%A1%8C)
    - [アーキテクチャ](#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3)
    - [UI/UXは伸び代が多い](#uiux%E3%81%AF%E4%BC%B8%E3%81%B3%E4%BB%A3%E3%81%8C%E5%A4%9A%E3%81%84)
    - [スーパー管理画面](#%E3%82%B9%E3%83%BC%E3%83%91%E3%83%BC%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2)
    - [使用技術の扱いづらさ](#%E4%BD%BF%E7%94%A8%E6%8A%80%E8%A1%93%E3%81%AE%E6%89%B1%E3%81%84%E3%81%A5%E3%82%89%E3%81%95)
    - [使用ツールの扱いづらさ](#%E4%BD%BF%E7%94%A8%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AE%E6%89%B1%E3%81%84%E3%81%A5%E3%82%89%E3%81%95)
    - [読み解けないブランチ](#%E8%AA%AD%E3%81%BF%E8%A7%A3%E3%81%91%E3%81%AA%E3%81%84%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81)
    - [DB設計の負債](#db%E8%A8%AD%E8%A8%88%E3%81%AE%E8%B2%A0%E5%82%B5)
    - [開発者体験の悪さ](#%E9%96%8B%E7%99%BA%E8%80%85%E4%BD%93%E9%A8%93%E3%81%AE%E6%82%AA%E3%81%95)
    - [分析基盤の弱さ](#%E5%88%86%E6%9E%90%E5%9F%BA%E7%9B%A4%E3%81%AE%E5%BC%B1%E3%81%95)
- [どういう方針で解決しようと考えているのか](#%E3%81%A9%E3%81%86%E3%81%84%E3%81%86%E6%96%B9%E9%87%9D%E3%81%A7%E8%A7%A3%E6%B1%BA%E3%81%97%E3%82%88%E3%81%86%E3%81%A8%E8%80%83%E3%81%88%E3%81%A6%E3%81%84%E3%82%8B%E3%81%AE%E3%81%8B)
  - [📅 2022~2023前半: 負債の影響を受けづらく、ユーザーに影響が大きいものから着手](#-20222023%E5%89%8D%E5%8D%8A-%E8%B2%A0%E5%82%B5%E3%81%AE%E5%BD%B1%E9%9F%BF%E3%82%92%E5%8F%97%E3%81%91%E3%81%A5%E3%82%89%E3%81%8F%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%AB%E5%BD%B1%E9%9F%BF%E3%81%8C%E5%A4%A7%E3%81%8D%E3%81%84%E3%82%82%E3%81%AE%E3%81%8B%E3%82%89%E7%9D%80%E6%89%8B)
    - [デザインのフルリニューアル](#%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E3%83%95%E3%83%AB%E3%83%AA%E3%83%8B%E3%83%A5%E3%83%BC%E3%82%A2%E3%83%AB)
    - [新規事業の開発](#%E6%96%B0%E8%A6%8F%E4%BA%8B%E6%A5%AD%E3%81%AE%E9%96%8B%E7%99%BA)
    - [スマホネイティブの開発](#%E3%82%B9%E3%83%9E%E3%83%9B%E3%83%8D%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E3%81%AE%E9%96%8B%E7%99%BA)
  - [📅 2023後半: 運用を効率化する](#-2023%E5%BE%8C%E5%8D%8A-%E9%81%8B%E7%94%A8%E3%82%92%E5%8A%B9%E7%8E%87%E5%8C%96%E3%81%99%E3%82%8B)
  - [課題解決に向けた好材料](#%E8%AA%B2%E9%A1%8C%E8%A7%A3%E6%B1%BA%E3%81%AB%E5%90%91%E3%81%91%E3%81%9F%E5%A5%BD%E6%9D%90%E6%96%99)
    - [👓 経営陣の理解がある](#-%E7%B5%8C%E5%96%B6%E9%99%A3%E3%81%AE%E7%90%86%E8%A7%A3%E3%81%8C%E3%81%82%E3%82%8B)
    - [🔥 学習意欲が高いメンバーで構成されている](#-%E5%AD%A6%E7%BF%92%E6%84%8F%E6%AC%B2%E3%81%8C%E9%AB%98%E3%81%84%E3%83%A1%E3%83%B3%E3%83%90%E3%83%BC%E3%81%A7%E6%A7%8B%E6%88%90%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B)
    - [💭 自由な意思決定](#-%E8%87%AA%E7%94%B1%E3%81%AA%E6%84%8F%E6%80%9D%E6%B1%BA%E5%AE%9A)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# 今アガルートはどのような課題を抱えているのか
アガルートアカデミーは現時点で以下の課題を抱えています。

## 技術的課題

### アーキテクチャ
- 全体的に責務が不明確で、ほぼ全てのロジックがコントローラーかモデルに記述されている。テスタビリティが壊滅的に低いためテストカバレッジも低く、デプロイが恐い。デプロイが怖いからリリース頻度が下がりビッグバンリリースになりがちなど、悪循環が生まれている。またドメインロジックが1箇所に集まっていないため仕様を把握しづらい
	- ✅ DONE: 巨大なモノリス化していたユーザー向け画面と管理画面を分離して独自デプロイ可能な状態に
	- ✅ DONE: [毎週月曜日に本番デプロイを行う](https://www.amazon.co.jp/dp/4295004901)ように運用を変えた。仮に不具合が生じたとしても軽微な修正で対応できる、チームがデプロイやロールバックの対応に慣れる、デプロイパイプラインがメンテナンスされるようになるなどの効果に期待
	- ✅ DONE: 最低限のハッピーパスを網羅したE2EテストをCypressで記述。リリースにかかる負荷を減らした。もう少しカバレッジを上げたい
	- ✅ DONE:: ドメインエキスパートと協力してユビキタス言語集を作成。少しずつドメイン理解を深めている
- 全てのスタイルが一つのCSSファイルにまとまっているため、名前が衝突したらどこのスタイルが崩れるか予測がつかない。ビジュアルリグレッションテストもない。つまり触るのが怖い
	- 🚧 WIP: フロントエンドが jQuery で書かれていることもあり、特にフロントエンドの保守性が低い。後述の通りUI/UXにも改善の余地が残されているためデザインのフルリニューアルを行うついでにReact/TSで書き換えている
### UI/UXは伸び代が多い
- 少々古さを感じるデザインに加え、スマホでの利用を想定されていない。一般的には見られないUIも多くユーザに学習コストを強いるため、改善の必要がある
	- 🚧 WIP: デザインのフルリニューアルに着手中。アガルートは難関資格を中心に取り扱っているため、1年近く試験勉強を続けているユーザーも多い。既存UIに慣れているユーザーも多いことが想定されるため、ユーザーには新旧 UIを選択する余地を与える必要がある。現状のLaravelの作りも勘案して、[Inertiajs](https://inertiajs.com/)を採用することで極力既存サービスの負債の影響を受けずに新UIを開発している
### スーパー管理画面
- 管理者が利用するものはひとまず全て管理者画面にまとめている。物流担当者が使用する機能、講師が使用する機能、CRM、商品管理、更には別サービスの管理機能など、ありとあらゆる機能が集約されている。命名は似ているものの概念として異なるコードが散見されるため改修しづらく、ある機能を改修した際、他機能にどこまで影響を与えるのか判断しづらい
	- 🤔 TODO: ユーザーに直接影響が大きい施策から優先的に実施しているため、管理画面の分割は後回しにされている
### 使用技術の扱いづらさ
- フロントエンドの動的部分はjQueryで記述されている。辛すぎる。
	- 🚧 WIP: React/TSで書き直し中
- バックエンドが非常に古いバージョンのphpで記述されている。採用上あまり有利に働く言語選定ではない
	- ✅ DONE: php8系、Laravel9系にバージョンアップ
	- 🚧 WIP: 法人向けの新機能など今後追加するサービスは既存サービスとは完全に分離してReact+TS/Rustで開発中
- むしろどうやって見つけたのかと気になる、ニッチな日系外部サービスを使用している業務フローが多く、エンハンスの際に苦労する
	- 🤔 TODO: ユーザーに直接影響が大きい施策から優先的に実施しているため、業務フロー改善は後回しにされている
### 使用ツールの扱いづらさ
- コード管理がcodeCommitで行われている
	- 他プロジェクトで作成したGitHub ActionなどCI用コードが使いまわせない
	- GitHubの個人アカウントで草が生やせないためエンジニアのキャリア形成の足を引っ張ってしまう可能性がある
	- サードパーティプラグインの開発も豊富で、多くの開発者が使い慣れているであろうツール（GitHub）を放棄して追加の学習コストをかけてまで得られるメリットは今の段階では存在しない
		- ✅ DONE: GitHubに移行完了
- 元々使用されていた日系コミュニケーションツールではUI/UX、連携ツールの制約を受ける点から苦しかった
	- ✅ DONE: Slackに移行。開発メンバーへの連絡は全てSlackに集約してもらった
### 読み解けないブランチ
- stale状態のブランチが40個以上ある。特定環境のデプロイと関連するため削除してはいけないブランチも存在する。またデフォルトのブランチは現在使われていないなど、見慣れないブランチ運用のためマージする際に恐怖を感じる
	- ✅ DONE: 確認の上、全てのブランチを削除。git flowをベースにブランチ運用ルールを定義
### DB設計の負債
- 至るところに散見される論理フラグに苦しめられている
- 商品周りのDB設計が非常に煩雑。科目と講座の違いなど、本当に別の概念としてモデリングすべきものだったのか疑問を感じる内容が多く、新規参画者のオンボーディングスピードが低下している
	- 🤔 TODO: 少なくとも新規機能に関してはマイクロサービス的にデータベースレベルで分離することで既存のデータベース負債に引きずられないようにしている
### 開発者体験の悪さ
- 相当な黒魔術を駆使しないとデプロイがままならない
	- ✅ DONE: GitHub Actionsでデプロイを自動化した
- 開発環境を立ち上げるまでに数日を要する。zipをダウンロードして指定ディレクトリに配置するなど、非常に手順が複雑で新規参画者の立ち上がりを阻害している
	- ✅ DONE: 開発環境をDocker化した
- 開発環境でスロークエリが多発している
	- 🤔 TODO: 
### 分析基盤の弱さ
- 定量的にデータを分析する基盤がないため、事実に基づく意思決定を行いづらい
	- ✅ DONE: AWS [QuickSight](https://aws.amazon.com/quicksight/)を導入して本番データを可視化した
	- 🤔 TODO: Amplitudeなどを活用してユーザ行動分析の基盤も構築したい
	- 🤔 TODO: React/TSへの移行が完了次第LogRocketなどフロントエンドモニタリングツールを導入して、サイレントクレーム化している可能性のあるユーザーの不便を抽出したい

# どういう方針で解決しようと考えているのか
- 極力負債の影響を受けづらく、かつユーザーに影響が大きいものからエンハンスしていきたい。
- 以下の図の「1」の領域から着手。技術負債に足を引っ張られて全く機能追加できていなかったこれまでと変わり、新しい開発チームなら着実に商品を改善していけることをグループ全体に信頼してもらう必要がある

![image](https://user-images.githubusercontent.com/32860372/199471157-5e062cbc-2211-4840-a81c-7c785a9f9942.png)


## 📅 2022~2023前半: 負債の影響を受けづらく、ユーザーに影響が大きいものから着手
### デザインのフルリニューアル
- デザインリニューアルであれば既存サービスのバックエンドに触れる必要も、jQueryに触れる必要もない。かつカスタマーのUI/UXに大きく寄与するため、こちらに着手中

### 新規事業の開発
- これまで価値提供できていなかった法人向け新規事業を開発中。新規サービスはDBレベルで既存サービスとは分離。既存サービスにはほぼ触れる必要がないため技術選定も比較的自由。今回はRustを採用。

### スマホネイティブの開発
- 現時点でアガルートにはネイティブアプリがない。スマホでの利用を前提としたUIでオフライン再生にも対応して、例えば通勤中やちょっとした休憩時間にも学習できるようにしたい
- 既存サービスのバックエンドは負債が積み重なりすぎて触れないため、スマホ用のAPIを新規開発する予定
- 将来的にはBFFを挟んでリニューアル後のWEBフロントエンドも（元は）スマホ用のAPIを参照するようにすれば既存バックエンドに手を触れることなく破棄できる予定。できたらめちゃくちゃ嬉しい

## 📅 2023後半: 運用を効率化する
- 上記対応が完了すれば、4の領域にはほとんど何も残らない予定。新機能は既存アプリケーションをエンハンスするのではなく極力分離されたマイクロサービスとして開発する方向を模索する
- ユーザー向けの直接的な影響が多いエンハンスが落ち着いたタイミングで２、３の領域に着手。責務の異なる機能が集まりすぎた管理画面を別々のサービスに分解する

## 課題解決に向けた好材料
### 👓 経営陣の理解がある
例えば以下のような点について経営会議で話し合い、経営陣に理解してもらっています。開発に関する共通認識を持てているため意思決定が非常に円滑です。

- 既存サービスに技術的負債が蓄積していること
- それにより開発スピードが大きく低下していること
- これだけ蓄積した負債を返済するにはこれまで開発にかけたのと同程度の工数がかかること
- 少数精鋭で開発した方が圧倒的に高いパフォーマンスが出せること
- 優秀なエンジニアを採用するには時間とコストがかかること

### 🔥 学習意欲が高いメンバーで構成されている
- 計4時間に及ぶライブコーディング面接を通してスキルを正確に評価する
- 1年近くメンターとして接してきた[プラハチャレンジ](https://praha-challenge.com/)の卒業生を積極的に採用する
- グループ会社で高い成果と学習意欲を発揮しているエンジニアをリクルーティングする

などの取り組みを通して、学習意欲が高く、自分が書くコードをきちんと考え抜くエンジニアを中心に採用しています。

- 良いものを作るためには、耐えず考えて学び続ける必要がある
- 長く使えるサービスを作るには、直接的な機能追加の他にも工数を投資する必要がある
- 短期的な利益だけではなく長期的な視点も組み合わせて考える必要がある

こうした共通認識を持った開発チームで、良いものを作ることに集中して取り組める環境です。

### 💭 自由な意思決定
アガルートテクノロジーズは社員を大人扱いします。つまり、自分の仕事を自分で選択する判断能力と、管理されなくても自分に出来るベストを尽くす自己管理能力を兼ね備えていると信じる、ということです。

組織形態はホラクラシーを採用しています。

社員には自分で自分の仕事を選択したり、新しい仕事を作り出すことが許されています。自分自身が最も高いパフォーマンスを発揮できる仕事を社員が自分自身で選べる時、組織のパフォーマンスも最大化されると考えているからです。

DevOpsに興味があれば開発プロセスの改善を自分の仕事にしても構いません。データ基盤の構築に興味があればアガルートアカデミーに蓄積されたデータを整理してBI機能を充実させることを自分の仕事にしても構いません。

- 興味がある
- チームが必要としている
- ユーザーの役に立つ

これらの条件が重なり合う領域を自分自身で見つける判断力があることを信じています。

また裁量労働制を採用しており、社員の稼働を毎日細かく管理することはありません。誰かに管理されなくても自分が夢中になれるテーマを自ら見つけて取り組む自己管理能力を持っていることを信頼しています。
